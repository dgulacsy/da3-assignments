---
title: "Finding fast growing firms"
subtitle: "DA3 Assignment 2"
author: "Attila Szuts, Dominik Gulacsy"
date: "2/10/2021"
code_download: yes
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE)
```

## [Github Repo](https://github.com/dgulacsy/da3-assignments/tree/main/da3-assignment2)

```{r}
rm(list = ls())
library(tidyverse)
library(caret)
library(party)
library(GGally)
library(pROC)

source("codes/helper.R")
```

# Introduction
In this analytics project we are aiming to find the best model to predict fast growth firms based on their various characteristics and financial indicators. To place this task into a business environment we assumed that the main business motivation behind this whole analytics project is to identify those firms that worth investing in. We did not define a specific form of investment worth considering the predicted firms may be considered for fusion, acquisition or simple buy-in. To find the best a model, first of all we go through all the steps of sample design, label engineering and feature engineering. We also look at some results of our exploratory data analysis to see which particular aspects of the data we should keep in mind and what kind of model specifications we should come up. During our analysis we run altogether 7 models increasing complexity and finally a model using LASSO. I compare and assess model performance and recommend a final model for the prediction problem.


# Label engineering



# Data Cleaning/Wrangling





# Model preparation

## 1. Train test split

```{r}
df <- read_rds("data/clean/fast-growth-firms-workfile.rds")

# df$is_fg <- as.factor(df$is_fg)
# df$f_is_fg <- as.factor(ifelse(df$f_is_fg == "fast growth", "fast_growth", "no_fast_growth"))

# create smaller sample to test models
samp_size <- round(nrow(df) / 5)
set.seed(1234)
df <- sample_n(df, samp_size)
nrow(df)
df <- df[!is.na(df$is_fg),]
nrow(df)
df <- na.omit(df)
nrow(df)

set.seed(1234)
training_ratio <- 0.7
train_indices <- createDataPartition(
  y = df[["is_fg"]],
  times = 1,
  p = training_ratio,
  list = FALSE
) %>% as.vector()
data_train <- df[train_indices, ]
data_test <- df[-train_indices, ]
```

## 2. Variable selection

```{r}
target <- c("is_fg")
business <- c("ind2_cat","urban","region","labor_avg","age","age2","new")
ceo <- c("ceo_inoffice_years","ceo_age","ceo_count",
        "ceo_female","ceo_foreign","ceo_gender","ceo_origin")
sales <- c("sales_mil_log","d1_sales_mil_log")
financial_basic <- c("curr_assets","curr_liab","fixed_assets","tang_assets",
                     "intang_assets","inventories","liq_assets","subscribed_cap",
                     "share_eq","material_exp","personnel_exp","amort","profit","d1_profit")
financial_ext <- c("extra_exp","extra_inc","extra_profit_loss","inc_bef_tax")
financial_basic_ratios <- colnames(df %>% select(matches("*._bs|*._pl")))
financial_ext_ratios <- colnames(df %>% select(matches("*._ratio")))
flags <- colnames(df %>% select(matches("*.flag.")))

formula_lpm = formula(paste0(target, paste0(" ~ ",paste(c(business, ceo,sales, financial_basic, financial_ext, financial_basic_ratios, flags),collapse = " + "))))
formula_log = formula(paste0(target, paste0(" ~ ",paste(c(business, ceo,sales, financial_basic, financial_ext, financial_basic_ratios, flags),collapse = " + ")))) 
formula_rf = c(business, ceo,sales, financial_basic, financial_ext, financial_basic_ratios, flags)
formula_gbm = vars(business, ceo,sales, financial_basic, financial_ext, financial_basic_ratios, flags)
formula_knn = formula(paste0(target, paste0(" ~ ",paste(c(business, ceo,sales, financial_basic, financial_ext, financial_basic_ratios, flags),collapse = " + "))))
formula_enet = formula(paste0(target, paste0(" ~ ",paste(c(business, ceo,sales, financial_basic, financial_ext, financial_basic_ratios, flags),collapse = " + "))))
```

# EDA
```{r}

df %>% select(where(is.numeric)) %>% ggcorr(layout.exp = 1)
ggpairs(df, columns = c(target, business))

# Check for multicollinearity and perfect collinearity
numeric_df <- keep( df , is.numeric )
cT <- cor(numeric_df , use = "complete.obs")

# Check for highly correlated values:
sum( abs( cT ) >= 0.8 & cT != 1 ) / 2
# Find the correlations which are higher than 0.8
id_cr <- which( abs( cT ) >= 0.8 & cT != 1 )
pair_names <- expand.grid( variable.names(numeric_df) , variable.names(numeric_df) )
# Get the pairs:
high_corr <- pair_names[ id_cr , ]
high_corr <- mutate( high_corr , corr_val = cT[ id_cr ] )
high_corr <- mutate(high_corr, Var1 = as.character(Var1))
high_corr <- mutate(high_corr, Var2 = as.character(Var2))
high_corr$vars<-unlist(lapply(1:nrow(high_corr),function(i){
  paste(sort(c(high_corr$Var1[i],high_corr$Var2[i])), collapse = "")
}))
high_corr<-high_corr[!duplicated(high_corr$vars),]
high_corr

```

# Modelling

##1. LPM

```{r}
model_lpm <- lm(formula_lpm, data =
                  data_train)
# 
# Error in `contrasts<-`(`*tmp*`, value = contr.funs[1 + isOF[nn]]) : 
#   contrasts can be applied only to factors with 2 or more levels
# 
model_lpm
```


##2. Logit

```{r}
model_logit <- glm(formula = formula_log, data = data_train, family = "binomial")
# 
# Error in `contrasts<-`(`*tmp*`, value = contr.funs[1 + isOF[nn]]) : 
#   contrasts can be applied only to factors with 2 or more levels
# 
model_logit
```


##3. Probit

```{r}
model_probit <- glm(formula = formula_log, data = data_train, family = binomial(link = "probit"))
# 
# Error in `contrasts<-`(`*tmp*`, value = contr.funs[1 + isOF[nn]]) : 
#   contrasts can be applied only to factors with 2 or more levels
# 
```

##4. Random Forest

```{r}
trctrl <- trainControl(method = "cv", number = 10)

# use all variables?
model_rf <- train(x = vars(formula_rf),
                  y = data_train$is_fg,
                  data = data_train, 
                  method = "rf",
                  trControl=trctrl,
                  num.threads = 7,
                 na.action = na.omit)

# 
# Error: Please use column names for `x`
# 

send_message()
model_caret
postResample(data_test$is_fg, predict(model_caret, data_test))

# colnames(data_test, 2)
```

```{r}
train_control <- trainControl(
  method = "cv",
  n = 5,
  classProbs = TRUE, # same as probability = TRUE in ranger
  # summaryFunction = twoClassSummaryExtended,
  savePredictions = TRUE
)
train_control$verboseIter <- TRUE

tune_grid <- expand.grid(
  .mtry = c(5, 6, 7),
  .splitrule = "gini",
  .min.node.size = c(10, 15)
)

# getModelInfo("ranger")
set.seed(13505)
rf_model_p <- train(
  data_train[formula_rf], data_train[["is_fg"]],
  method = "ranger",
  data = data_train,
  tuneGrid = tune_grid,
  trControl = train_control
)

# 
# model fit failed for Fold5: mtry=7, splitrule=gini, min.node.size=15 Error in ranger::ranger(dependent.variable.name = ".outcome", data = x,  : 
#   formal argument "data" matched by multiple actual arguments
# 
  
```

##5. Boosting

```{r}
start_time <- Sys.time()
# Train model with preprocessing & repeated cv
trctrl <- trainControl(method = "repeatedcv", 
                       number = 5, 
                       repeats = 3, 
                       verboseIter = FALSE)

model_gbm <- train(formula_gbm,
                   data = data_train,
                   method = "gbm",
                   trControl = trctrl,
                   verbose = 0,
                   num.threads = 7)
end_time <- Sys.time()
model_gbm

# 
# Error: Please use column names for `x`
# 

print(end_time - start_time)
send_message()
```


##6. KNN

```{r}
set.seed(1234)
trctrl <- trainControl(method = "repeatedcv", number = 10, repeats = 1)

model_knn <- train(formula_knn, data = data_train, method = "knn",
                 trControl=trctrl,
                 preProcess=c("center", "scale"),
                 tuneLength=20,
                 num.threads = 7
                 #tuneGrid = data.frame(k=c(2:8))
                 )
model_knn

# 
# Error: Please use column names for `x`
# 

send_message()

lmElasticNetCaret
knnModelRoc <- roc(predictor = predict(model_knn, data_test, type='prob', decision.values=T)$is_fg, response = data_test$is_fg)
knnModelRoc
plot(knnModelRoc)

postResample(SpamTest$count, predict(model_knn, SpamTest))
```


##7.  Elastic Net
```{r}
set.seed(1234)
trctrl <- trainControl(method = "cv", classProbs=TRUE, summaryFunction=twoClassSummary)

lmElasticNetCaret <- train(formula_enet, 
                 data = data_train, 
                 method = "glmnet",
                 trControl=trctrl,
                 tuneLength=5,
                 metric='AUC',
                 num.threads = 7
                 #tuneGrid = data.frame(lambda=seq(0.1,1,0.1), alpha=rep(1, 10))
)

# 
# Error: Please use column names for `x`
# 

```


```{r}
lasso_tune_grid <- expand.grid(
  "alpha" = c(1),
  "lambda" = seq(0.05, 0.5, by = 0.025)
)

ridge_tune_grid <- expand.grid(
  "alpha" = c(0),
  "lambda" = seq(0.05, 0.5, by = 0.025)
)

enet_tune_grid <- expand.grid(
  "alpha" = seq(0, 1, by = 0.1),
  "lambda" = union(lasso_tune_grid[["lambda"]], ridge_tune_grid[["lambda"]])
)

set.seed(857)
enet_fit <- train(
  formula(formula_enet),
  data = data_train,
  method = "glmnet",
  preProcess = c("center", "scale"),
  tuneGrid = enet_tune_grid,
  trControl = fit_control
)

# 
# Error in na.fail.default(list(is_fg = c(2, 1, 1, 1, 1, 2, 2, 1, 2, 2,  : 
#   missing values in object
# 

```


```{r}
lmElasticNetCaret
lmElasticNetCaretRoc <- roc(predictor = predict(lmElasticNetCaret, data_test, type='prob', decision.values=T), response = data_test$f_is_fg)
lmElasticNetCaretRoc
plot(lmElasticNetCaretRoc)

confusionMatrix(data_test$f_is_fg, predict(lmElasticNetCaret, data_test, decision.values=T))

plot(lmElasticNetCaret)

coef(lmElasticNetCaret$finalModel, lmElasticNetCaret$bestTune$lambda)
postResample(data_test$f_is_fg, predict(lmElasticNetCaret, data_test))

```

